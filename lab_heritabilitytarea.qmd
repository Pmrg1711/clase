---
title: "Heredabilidad en el fitomejoramiento"
author: "Pedro M. Rodriguez-Grados"
format: "R"
  html:
    toc: true
    toc-location: left
    number-sections: true
    self-contained: true
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

```{r}
#| label: setup
#| include: false

source("https://inkaverse.com/docs.r")
knitr::opts_chunk$set(echo = T)

cran <- c("inti"
          , "metan"
          , "psych"
          , "FactoMineR"
          , "openxlsx"
          , "cowplot"
          , "readxl"
          , "dplyr"
          , "psych"
          , "magrittr"
          , "factoextra"
)
suppressPackageStartupMessages({
  for (pkgs in cran) { 
    if( !require(pkgs, character.only = T) ) {
      install.packages(pkgs)
      library(pkgs, character.only = T)
    } 
  }
remove(cran, pkgs)
})
```

# Base de datos

```{r}

install.packages("readxl")

library(readxl)

# Leer el archivo Excel
fb <- read_excel("C:/Users/pmrg1/OneDrive/Desktop/git/tarea/Table1.xlsx")

str(fb)
```

- Estructura correcta, NO necesita transformación

# Base de datos en excel

```{r eval=FALSE}
openxlsx::write.xlsx(x = fb, file = "met.xlsx")

getwd()

str(fb)

colnames(fb)

```

> Directorio de trabajo `getwd()`

# Correlación de variables

```{r}
# browseURL

png(filename = "correlation.png", width = 25, height = 25, units = "cm", res = 300)

fb %>%
  select(where(is.numeric)) %>%
  pairs.panels(
    hist.col = "red",
    pch = 21,
    method = "pearson",
    stars = TRUE,
    scale = TRUE,
    lm = TRUE
  )

dev.off()

# Usamos el mismo dataset fb
data_full <- fb

colnames(fb)

```

- ¿Qué variables muestran correlaciones interesantes?

# Análisis multivariado

```{r}
mv <- fb %>%
  select(where(is.numeric)) %>% 
  FactoMineR::PCA(scale.unit = TRUE, graph = FALSE)

# Visualización del PCA
fviz_pca_biplot(
  mv,
  repel = TRUE,
  geom.ind = "point",
  col.ind = as.factor(fb$`Location ID`),
  palette = "Spectral", 
  addEllipses = FALSE,
  title = "PCA de ambientes (todos los sitios)"
)

```

## Análisis de las variables

```{r}
plot1 <- plot.PCA(mv
                , choix = "var")

plot1
```

- ¿Qué variables estan correlacionadas?

## Análisis de los individuos

```{r}
plot2 <- plot.PCA(mv
         , choix = "ind"
         , cex = 0.8
         , shadowtext = T
         , label = "ind"
         , autoLab = "yes"
         , graph.type = "ggplot"
         )

plot2
```

- ¿Cuáles de los híbridos tuvieron mejores rendimientos?

```{r}
list(plot1, plot2) %>% 
  plot_grid(plotlist = .
            , nrow = 1
            , labels = "AUTO"
            , rel_widths = c(1, 1.5)
            )
```

# Heredabilidad

## Rendimiento

```{r}
hr <- H2cal(
  data = feno,
  trait = "Yield",
  gen.name = "GEN",
  rep.n = 3,
  env.name = "ENV",
  env.n = 4,
  fixed.model = ~ 0 + (1|REP) + (1|ENV) + GEN,
  random.model = ~ 1 + (1|REP) + (1|ENV) + (1|GEN),
  emmeans = TRUE,
  plot_diag = TRUE
)


```

### Componentes de la variancia

```{r}
hr$model %>% summary()

hr$tabsmr %>% web_table()
```

### BLUPs

```{r}
hr$blups %>%
  arrange(desc(KW)) %>% 
  kable()
```

## Altura de planta

```{r}
hr <- H2cal(data = fb
            , trait = "PH"
            , gen.name = "GEN"
            , rep.n = 3
            , env.name = "ENV"
            , env.n = 4
            , fixed.model = "0 + (1|REP) + (1|ENV) + (1|ENV:GEN) + GEN"
            , random.model = "1 + (1|REP) + (1|ENV) + (1|ENV:GEN) + (1|GEN)"
            , emmeans = TRUE
            , plot_diag = TRUE
            , outliers.rm = TRUE
            )
```

### Componentes de la variancia

```{r}
hr$model %>% summary()

hr$tabsmr %>% web_table()
```

### BLUPs

```{r}
hr$blups %>% 
  arrange(desc(PH))
  kable()
```

# Eficiencia de uso de agua en Papa

```{r}
#| eval: false

browseURL("https://docs.google.com/spreadsheets/d/15r7ZwcZZHbEgltlF6gSFvCTFA-CFzVBWwg3mFlRyKPs/edit#gid=1263018298")
```

## Análisis interactivo

```{r}
#| eval: false

inti::yupana(dependencies = T)
```

- Activar cuenta de google sheets
- Datos en una hoja de Google sheets


# Plot grid

```{r}
library(dplyr)
library(cowplot)

list(plot1, plot2) %>% 
  plot_grid(plotlist = .
            , nrow = 1
            , labels = "AUTO"
            , rel_widths = c(1, 1.6)
            ) %>% 
  ggsave2("figures/quantitative-genetics.png", plot = .
          , width = 30, height = 12, units = "cm")
```


